arch:
  - amd64
  - ppc64le
  - s390x

dist: focal
os: linux
language: bash
services:
  - docker

before_install:
  - echo "Bash version: $BASH_VERSION"
  - if [ "$(uname -m)" = "ppc64le" ]; then
      echo "Upgrading Docker on ppc64le...";
      for pkg in docker.io containerd runc; do sudo apt-get remove -y $pkg || true; done;
      sudo apt-get update;
      sudo install -m 0755 -d /etc/apt/keyrings;
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo tee /etc/apt/keyrings/docker.asc > /dev/null;
      sudo chmod a+r /etc/apt/keyrings/docker.asc;
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo ${UBUNTU_CODENAME:-$VERSION_CODENAME}) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null;
      sudo apt-get update;
      sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin;
    fi

script:
  - echo "Building base image..."
  - docker build -f Dockerfile.base -t test-base .
  - echo "Building child image..."
  - docker build -f Dockerfile.child -t test-child .
  - echo "Running child image..."
  - docker run --rm test-child
